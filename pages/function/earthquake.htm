<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,install-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>This is a test</title>
    <link rel="stylesheet" href="../../libs/ol.css">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="../../libs/ol.js"></script>

    <style>
        .map {
            width: 100%;
            height: 90%;
            position: absolute;
        }

        .ol-popup {
            overflow-y: auto;
            overflow-x: auto;
            background-color: rgba(7, 212, 231, 0.8);
        }

        .ol-popup-closer {
            text-align: right;

            display: inline-block;


            margin-left: 70%;


        }

        .datachoose {
            width: fit-content;
            top: 92.5%;
            position: absolute;
        }
    </style>

</head>

</head>

<body>
    <div id="mainmap" class="map"></div>

    <div id="popup" class="ol-popup">

        <div style="width: 100%;">
            <strong style="text-align: left;margin-left: 10px;width: 10%;">地震信息</strong>
            <a href="#" id="popup-closer" class="ol-popup-closer">x</a>
        </div>

        <div id="popup-content" style="display: inline-block;text-align:left; margin: 10px;"></div>
    </div>

    <div class="datachoose">
        <!-- <input type="button" value="近一小时" onclick="sethour()" />
        <input type="button" value="近一天内" onclick="setday()" />
        <input type="button" value="近七天内" onclick="setweek()" />
        <input type="button" value="近一个月" onclick="setmonth()" /> -->

        <div id="controls">
            <input type="checkbox" id="hour" />近一小时
            <input type="checkbox" id="day" />近一天内
            <input type="checkbox" id="week" />近一周内
            <input type="checkbox" id="month" checked />近一个月

            震级 >
            <input type="number" step="0.1" value="1.0" id="selectLevel" />
            <input type="button" value="筛选" onclick="magselect()" id="select" />
            
        </div>
        
            
        
    </div>



    <script>
        //下面开始分别创建近一小时、一天、一周、一个月的vector图层
        var vector_hour = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson',
                format: new ol.format.GeoJSON({ extractStyles: false }),

            }),
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'rgba(255,15,15,0.4)'
                    })
                })
            })
        })

        var vector_day = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson',
                format: new ol.format.GeoJSON({ extractStyles: false }),
            }),
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'rgba(255,15,15,0.4)'
                    })
                })
            })
        })

        var vector_week = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson',
                format: new ol.format.GeoJSON({ extractStyles: false }),
            }),
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'rgba(255,15,15,0.4)'
                    })
                })
            })
        })

        var vector_month = new ol.layer.Vector({
            //创建地震点要素矢量图层vector
            source: new ol.source.Vector({

                url: 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson',
                format: new ol.format.GeoJSON({ extractStyles: false }),
            }),
            //style要放在source外面和它并列啊你这个笨蛋


            style: new ol.style.Style({
                //因为把image打成Image又浪费了我半个小时
                image: new ol.style.Circle({
                    radius: 5,
                    fill: new ol.style.Fill({
                        color: 'rgba(255,15,15,0.4)'
                    })
                })
            })

        })

        var raster = new ol.layer.Tile({
            // source: new ol.source.XYZ({
            //     //url: "http://t3.tianditu.com/DataServer?T=img_w&tk=3bc6874f2b919aa581635abab7759a3f"
            //     url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
            // })
            source: new ol.source.OSM()
        })
        //最后是我们的底图

        //实例化我们的map
        var chinaextent = [7938658, 1055130,
            16125429, 7345809]

        //用来筛选的图层
        var newlayer = new ol.layer.Vector({
            source: new ol.source.Vector({

                url: 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson',
                format: new ol.format.GeoJSON({ extractStyles: false }),
            }),
        })
        var map = new ol.Map({
            target: 'mainmap',
            layers: [raster, newlayer, vector_month],//将地图瓦片图层和矢量点要素地震图层叠加显示
            view: new ol.View({
                //center: ol.extent.getCenter(chinaextent),
                center: [0, 0],
                projection: 'EPSG:3857',
                zoom: 0
            }),

            //下面是一些地图控件
            controls: ol.control.defaults().extend([
                new ol.control.ZoomSlider(),

                new ol.control.ZoomToExtent({
                    extent: [
                        /* 12728348, 3570593,
                        12732131, 3574443 */
                        //局部定位控件，坐标是经纬度的左下和右上,这里定位到中国
                        7938658, 1055130,
                        16125429, 7345809

                    ]
                }),

                new ol.control.MousePosition(),//显示鼠标所在位置经纬度的控件，默认位置右上角

                new ol.control.FullScreen(),//全屏控件

                new ol.control.OverviewMap({        // 实例化一个OverviewMap类的对象，并加入到地图中
                    collapsed: false,

                    //教程有误，需要加入新的layers和view，否则鹰眼框与主视图使用统一图层会显示空白
                    layers: [new ol.layer.Tile({
                        //source: new ol.source.XYZ({ url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}" }) 
                        source: new ol.source.OSM()
                    })],
                    view: new ol.View({
                        //center: ol.extent.getCenter(chinaextent),
                        center: [0, 0],
                        projection: 'EPSG:3857',
                        zoom: 0
                    }),
                }),

                new ol.control.ScaleLine({
                    units: "metric",//设置比例尺单位，degrees、imperial、us、nautical、metric（度量单位）
                    bar: false
                }),

            ])
        })
        newlayer.setVisible(false)
    </script>


    <script>
        var copyLayer

        //接下来设置popup弹窗显示要素属性信息
        var popup_container = document.getElementById('popup')
        var popup_content = document.getElementById('popup-content')
        var popup_closer = document.getElementById('popup-closer')

        //定义一个overlay用来显示popup
        var overlay = new ol.Overlay({
            element: popup_container,
            autoPan: true,
            autoPanAnimation: {
                duration: 250
            }
        })

        //定义关闭popup的控件
        popup_closer.onclick = function () {
            overlay.setPosition(undefined);
            popup_closer.blur();
            return false;
        }

        //这里小放一个时间戳转换工具
        function add0(m) { return m < 10 ? '0' + m : m }
        function format(shijianchuo) {
            //shijianchuo是整数，否则要parseInt转换
            var time = new Date(shijianchuo);
            var y = time.getFullYear();
            var m = time.getMonth() + 1;
            var d = time.getDate();
            var h = time.getHours();
            var mm = time.getMinutes();
            var s = time.getSeconds();
            return y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s);
        }

        //!!定义一个这样的自己的添加互动的函数很关键。
        //它让我可以使用它在切换了不同vector之后可以刷新我的select的图层对应到当前图层，只需要在切换函数里使用该函数即可
        var panduan=0
        function Myaddinteraction() {

            
            //var presentLayer = map.getLayers().getArray()[2]//获得当前vector图层

            if(panduan==0){var presentLayer = map.getLayers().getArray()[2]}
            if(panduan==1){var presentLayer = map.getLayers().getArray()[1]}

            //设置点击后样式
            var selectpoint = new ol.interaction.Select({
                layers: [presentLayer],
                multi: true,
                //hitolerance:4,
                style: new ol.style.Style({
                    //因为把image打成Image又浪费了我半个小时
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({
                            color: 'red'
                        })
                    })
                })
            })


            //设置点击后事件
            selectpoint.on('select', function (p) {

                var features = p.target.getFeatures().getArray()//获取真正的featrue元素

                if (features.length > 0) {


                    var obj = features[0];
                    console.log(obj.get('type'));//显示类型
                    var coordinate = p.mapBrowserEvent.coordinate
                    var property = obj.getProperties();//获取真正的属性信息
                    var geometry = obj.getGeometry();//获取地理数据信息
                    var json_obj = eval(obj)

                    //下面是摸索到的在geojson里面引用数据的方法，不知道直接用csv会不会简单点
                    var ftype = property["type"]
                    var ftitle = property["title"]
                    var otitle = obj.get('title')//事实证明这种获取方法默认是在properties下的数据

                    //properties数据引用
                    var time = property['time']
                    mytime = format(time)
                    var place = property["place"]
                    var level = property["mag"]

                    var url = property['url']
                    //geometry下的数据只能这样引用
                    var geotype = geometry.getType();
                    var geocoordinates = geometry.getCoordinates();
                    var jwd = ol.proj.transform(geocoordinates, 'EPSG:3857', 'EPSG:4326');


                    popup_content.innerHTML = `
                    
                    
                    <p>时间：`+ mytime + `</p>
                    <p>地点：`+ place + `</p>
                    <p>震级:`+ level + `</p>
                    <p>坐标:`+ jwd + `</p>
                    <div>
                      详情：
                      <a href="`+ url + `">link</a>
                    </div>
                    `

                    overlay.setPosition(coordinate);//定义弹出框的位置
                    map.addOverlay(overlay)/*加入地图之中*/
                }

            })

            map.addInteraction(selectpoint)
        }
        Myaddinteraction()



    </script>

    <!--   <script>//后用下面的复选框代替了功能
        function sethour() {
            var layers = map.getLayers().getArray()
            var first = layers[0]
            //var sec = layers[1]
            var sec = map.getLayers().item(1)//事实证明两种引用方法都是欧克的

            map.removeLayer(sec)
            map.addLayer(vector_hour)
            Myaddinteraction()
        }
        function setday() {
            var layers = map.getLayers().getArray()
            var first = layers[0]
            var sec = layers[1]

            map.removeLayer(sec)
            map.addLayer(vector_day)
            Myaddinteraction()
        }
        function setweek() {
            var layers = map.getLayers().getArray()
            var first = layers[0]
            var sec = layers[1]

            map.removeLayer(sec)
            map.addLayer(vector_week)
            Myaddinteraction()
        }
        function setmonth() {
            var layers = map.getLayers().getArray()
            var first = layers[0]
            var sec = layers[1]

            map.removeLayer(sec)
            map.addLayer(vector_month)
            Myaddinteraction()
        }
    </script> -->

    <script>//复选框实现单切数据
        var checkhour = document.getElementById('hour')
        var checkday = document.getElementById('day')
        var checkweek = document.getElementById('week')
        var checkmonth = document.getElementById('month')

        let controls = document.getElementById('controls')
        controls.addEventListener('click', (event) => {
            if (event.target.checked) {
                panduan=1
                newlayer.setVisible(false)
                switch (event.target.id) {
                    case "hour":
                        checkday.checked = false
                        checkweek.checked = false
                        checkmonth.checked = false

                        var layers = map.getLayers().getArray()
                        var first = layers[0]
                        //var sec = layers[1]
                        var sec = map.getLayers().item(1)//事实证明两种引用方法都是欧克的



                        map.removeLayer(layers[2])
                        map.addLayer(vector_hour)


                        vector_hour.setVisible(true);
                        
                        Myaddinteraction()

                        break;
                    case "day":
                        checkhour.checked = false
                        checkweek.checked = false
                        checkmonth.checked = false

                        var layers = map.getLayers().getArray()
                        var first = layers[0]
                        var sec = layers[1]


                        map.removeLayer(layers[2])
                        map.addLayer(vector_day)


                        vector_day.setVisible(true);
                        
                        Myaddinteraction()


                        break;
                    case "week":
                        checkhour.checked = false
                        checkday.checked = false
                        checkmonth.checked = false

                        var layers = map.getLayers().getArray()



                        map.removeLayer(layers[2])
                        map.addLayer(vector_week)

                        vector_week.setVisible(true);
                        
                        Myaddinteraction()


                        break;
                    case "month":
                        checkhour.checked = false
                        checkday.checked = false
                        checkweek.checked = false

                        var layers = map.getLayers().getArray()



                        map.removeLayer(layers[2])
                        map.addLayer(vector_month)


                        vector_month.setVisible(true);
                        
                        Myaddinteraction()


                        break;

                    default:
                        break;
                }
               
            }
            else{
                if(event.target.id=="select"||event.target.id=="selectLevel"){}
                else{var layers = map.getLayers().getArray()
                layers[2].setVisible(false)
                layers[1].setVisible(false)}
                
            }
        })
    </script>

    <script>




        function magselect() {

            var layer = map.getLayers().getArray()[2]
            var source = layer.getSource()
            var style = layer.getStyle()



            newlayer.setStyle(style)
            var newsource = newlayer.getSource()
            newsource.clear()

            var searchFeatures = source.getFeatures()



            //var copysource=copyLayer.getSource()

            var value = document.getElementById('selectLevel').value

            searchFeatures.forEach(function (item) {

                var level = item.get('mag')
                console.log(level)
                if (level >= value) {
                    newsource.addFeature(item)
                }
            });


            layer.setVisible(false);
            newlayer.setVisible(true);
        }

    </script>

</body>

</html>